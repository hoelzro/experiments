<html>
  <head>
    <title>React Test</title>
    <style type='text/css'>
      /* shamelessly adapted from https://developer.mozilla.org/en-US/docs/Web/HTML/Element/blink */
      .blink {
        animation: 1s linear infinite condemned_blink_effect;
      }

      @keyframes condemned_blink_effect {
        0% {
          visibility: hidden;
        }
        50% {
          visibility: hidden;
        }
        100% {
          visibility: visible;
        }
      }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script type='text/javascript' src='https://unpkg.com/babel-standalone@6/babel.min.js'>
    </script>
    <script type='text/babel'>
      function formatSecondsRemaining(seconds) {
        let hours = Math.floor(seconds / 3600);
        seconds %= 3600;

        let minutes = Math.floor(seconds / 60);
        seconds %= 60;

        return [ hours, minutes, seconds ].map(value => value.toString().padStart(2, '0')).join(':');
      };

      class Countdown extends React.Component {
        constructor(props) {
          super(props);
          this.interval = null;
          this.state = {
            state: 'stopped',
            secondsRemaining: 0,
            secondsTotal: null,
          };
        }

        handleCountdownSecondsChanged(e) {
          this.setState({
            secondsTotal: parseInt(e.target.value),
          });
        }

        handleTick() {
          // XXX is this the right way to go about this?
          if(this.state.secondsRemaining <= 1) {
            this.pauseTimer();
          }

          this.setState((state, _) => {
            let secondsRemaining = state.secondsRemaining - 1;

            if(secondsRemaining <= 0) {
              return { secondsRemaining, state: 'firing' };
            } else {
              return { secondsRemaining };
            }
          });
        }

        startTimer() {
          this.setState((state, props) => ({
            secondsRemaining: state.secondsTotal,
          }));

          this.resumeTimer();
        }

        resumeTimer() {
          this.setState({
            state: 'running',
          });

          this.interval = setInterval(this.handleTick.bind(this), 1000);
        }

        pauseTimer() {
          clearInterval(this.interval);
          this.interval = null;

          this.setState({
            state: 'paused',
          });
        }

        // XXX this duplication of which state things can be in feels icky
        handleStart() {
          if(this.state.state == 'stopped') {
              this.startTimer();
          } else { // 'paused'
              this.resumeTimer();
          }
        }

        handlePause() {
          this.pauseTimer();
        }

        handleStop() {
          if(this.state.state == 'running') {
            this.pauseTimer();
          }

          this.setState({
            state: 'stopped',
          });
        }

        render() {
          function handleSubmit(e) {
            e.preventDefault();
          }

          let StartButton = () => {
            let state = this.state.state;

            if(state == 'running') {
              return null;
            }

            let isDisabled = this.state.secondsTotal === null || state == 'firing';

            if(isDisabled) {
              return <button disabled onClick={this.handleStart.bind(this)}>Start</button>;
            } else {
              return <button onClick={this.handleStart.bind(this)}>Start</button>;
            }
          };

          let PauseButton = () => {
            let state = this.state.state;

            if(state != 'running') {
              return null;
            }

            return <button onClick={this.handlePause.bind(this)}>Pause</button>;
          };

          let StopButton = () => {
            let isDisabled = this.state.state == 'stopped';
            if(isDisabled) {
              return <button disabled onClick={this.handleStop.bind(this)}>Stop</button>
            } else {
              return <button onClick={this.handleStop.bind(this)}>Stop</button>
            }
          };

          let Timer = () => {
            switch(this.state.state) {
              case 'stopped':
                return null;
              case 'running':
                return formatSecondsRemaining(this.state.secondsRemaining);
              case 'paused':
                return <span className='blink'>{formatSecondsRemaining(this.state.secondsRemaining)}</span>;
              case 'firing':
                return <span className='blink'>{formatSecondsRemaining(this.state.secondsRemaining)}</span>;
            }
          };

          return (
            <div>
              <p>Countdown: <Timer /></p>
              <form onSubmit={handleSubmit}>
                <label htmlFor='countdown_seconds'>Countdown time:</label>
                <input type='number' name='countdown_seconds' onInput={this.handleCountdownSecondsChanged.bind(this)} />

                <br />

                <StartButton />
                <PauseButton />
                <StopButton />
              </form>
            </div>
          );
        }
      }

      function go() {
        let root = ReactDOM.createRoot(document.getElementById('react-root'));
        root.render(<Countdown />);
      }
    </script>
  </head>
  <body>
    <div id='react-root'>
    </div>

    <script type='text/javascript'>
      window.addEventListener('DOMContentLoaded', function() {
        go();
      });
    </script>
  </body>
</html>
