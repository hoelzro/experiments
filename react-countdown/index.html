<html>
  <head>
    <title>React Test</title>
    <style type='text/css'>
      /* shamelessly adapted from https://developer.mozilla.org/en-US/docs/Web/HTML/Element/blink */
      .blink {
        animation: 1s linear infinite condemned_blink_effect;
      }

      @keyframes condemned_blink_effect {
        0% {
          visibility: hidden;
        }
        50% {
          visibility: hidden;
        }
        100% {
          visibility: visible;
        }
      }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script type='text/javascript' src='https://unpkg.com/babel-standalone@6/babel.min.js'>
    </script>
    <script type='text/babel'>
      function formatSecondsRemaining(seconds) {
        let hours = Math.floor(seconds / 3600);
        seconds %= 3600;

        let minutes = Math.floor(seconds / 60);
        seconds %= 60;

        return [ hours, minutes, seconds ].map(value => value.toString().padStart(2, '0')).join(':');
      };

      class RunningTimer extends React.Component {
        constructor(props) {
          super(props);
          this.interval = null;
          this.deadline = (new Date()).getTime() + props.duration * 1000;
          this.state = {
            secondsRemaining: props.duration,
          };
        }

        componentDidMount() {
          this.interval = setInterval(this.handleTick.bind(this), 1000);
        }

        componentWillUnmount() {
          if(this.interval != null) {
            clearInterval(this.interval);
            this.interval = null;
          }
        }

        handleTick() {
          let now = new Date().getTime();
          let secondsRemaining = Math.max(0, (this.deadline - now) / 1000);

          if(secondsRemaining == 0) {
            clearInterval(this.interval);
            this.interval = null;
            let onExpired = this.props.onExpired;
            if(onExpired) {
              onExpired();
            }
          }

          this.setState({ secondsRemaining });
        }

        render() {
          return formatSecondsRemaining(this.state.secondsRemaining);
        }
      }

      function PausedTimer(props) {
        return <span className='blink'>{formatSecondsRemaining(props.duration)}</span>;
      }

      class Countdown extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            state: 'stopped',
            secondsTotal: null,
          };
        }

        handleCountdownSecondsChanged(e) {
          this.setState({
            secondsTotal: parseInt(e.target.value),
          });
        }

        startTimer() {
          this.resumeTimer();
        }

        resumeTimer() {
          this.setState({
            state: 'running',
          });
        }

        pauseTimer() {
          this.setState({
            state: 'paused',
          });
        }

        // XXX this duplication of which state things can be in feels icky
        handleStart() {
          if(this.state.state == 'stopped') {
              this.startTimer();
          } else { // 'paused'
              this.resumeTimer();
          }
        }

        handlePause() {
          this.pauseTimer();
        }

        handleStop() {
          if(this.state.state == 'running') {
            this.pauseTimer();
          }

          this.setState({
            state: 'stopped',
          });
        }

        handleExpired() {
          this.setState({
            state: 'firing',
          });
        }

        render() {
          function handleSubmit(e) {
            e.preventDefault();
          }

          let StartButton = () => {
            let state = this.state.state;

            if(state == 'running') {
              return null;
            }

            let isDisabled = this.state.secondsTotal === null || state == 'firing';
            return <button disabled={isDisabled} onClick={this.handleStart.bind(this)}>Start</button>;
          };

          let PauseButton = () => {
            let state = this.state.state;

            if(state != 'running') {
              return null;
            }

            return <button onClick={this.handlePause.bind(this)}>Pause</button>;
          };

          let StopButton = () => {
            let isDisabled = this.state.state == 'stopped';
            return <button disabled={isDisabled} onClick={this.handleStop.bind(this)}>Stop</button>
          };

          let timer;

          switch(this.state.state) {
            case 'stopped':
              timer = null;
              break;
            case 'running':
              timer = <RunningTimer duration={this.state.secondsTotal} onExpired={this.handleExpired.bind(this)} />;
              break;
            case 'paused':
              timer = <PausedTimer duration={this.state.secondsTotal} />;
              break;
            case 'firing':
              timer = <PausedTimer duration={0} />;
              break;
          }

          let CountdownInput = () => {
            return (
              <span>
                <label htmlFor='countdown_seconds'>Countdown time:</label>
                <input type='number' name='countdown_seconds' onInput={this.handleCountdownSecondsChanged.bind(this)} value={this.state.secondsTotal} disabled={this.state.state != 'stopped'}/>
              </span>
            );
          };

          return (
            <div>
              <p>Countdown: {timer}</p>
              <form onSubmit={handleSubmit}>
                <CountdownInput />

                <br />

                <StartButton />
                <PauseButton />
                <StopButton />
              </form>
            </div>
          );
        }
      }

      function go() {
        let root = ReactDOM.createRoot(document.getElementById('react-root'));
        root.render(<Countdown />);
      }
    </script>
  </head>
  <body>
    <div id='react-root'>
    </div>

    <script type='text/javascript'>
      window.addEventListener('DOMContentLoaded', function() {
        go();
      });
    </script>
  </body>
</html>
